# –ü—Ä–æ—Å—Ç–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ Cloudflare Worker –¥–ª—è OAuth (–ë–ï–°–ü–õ–ê–¢–ù–û)

## –ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ

–≠—Ç–æ —Ä–µ—à–µ–Ω–∏–µ –ø–æ–∑–≤–æ–ª—è–µ—Ç Google OAuth –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –≤–∞—à –¥–æ–º–µ–Ω (`ccplearn.pages.dev` –∏–ª–∏ –∫–∞—Å—Ç–æ–º–Ω—ã–π) –≤–º–µ—Å—Ç–æ `supabase.co` **–±–µ—Å–ø–ª–∞—Ç–Ω–æ**.

## –í–∞–∂–Ω–æ –ø–æ–Ω–∏–º–∞—Ç—å

‚ö†Ô∏è **–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ**: Supabase SDK –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç OAuth URL —Å –¥–æ–º–µ–Ω–æ–º Supabase. –ß—Ç–æ–±—ã Google –ø–æ–∫–∞–∑—ã–≤–∞–ª –≤–∞—à –¥–æ–º–µ–Ω, –Ω—É–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å OAuth —Ç–∞–∫, —á—Ç–æ–±—ã callback —à–µ–ª –Ω–∞ –≤–∞—à –¥–æ–º–µ–Ω —á–µ—Ä–µ–∑ Worker.

‚úÖ **–†–µ—à–µ–Ω–∏–µ**: –ù–∞—Å—Ç—Ä–æ–∏—Ç—å Google OAuth callback –Ω–∞ –≤–∞—à –¥–æ–º–µ–Ω, –∞ Worker –±—É–¥–µ—Ç –ø—Ä–æ–∫—Å–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø—Ä–æ—Å—ã –Ω–∞ Supabase.

## –ü–æ—à–∞–≥–æ–≤–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è

### –®–∞–≥ 1: –°–æ–∑–¥–∞–π—Ç–µ Cloudflare Worker

1. –í–æ–π–¥–∏—Ç–µ –≤ [Cloudflare Dashboard](https://dash.cloudflare.com/)
2. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ **Workers & Pages** ‚Üí **Create application** ‚Üí **Create Worker**
3. –ù–∞–∑–æ–≤–∏—Ç–µ Worker: `supabase-auth-proxy`
4. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –∫–æ–¥ –∏–∑ `cloudflare-worker-auth-proxy.js`
5. –ù–∞–∂–º–∏—Ç–µ **Deploy**

### –®–∞–≥ 2: –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

–í Worker, –ø–µ—Ä–µ–π–¥–∏—Ç–µ –≤ **Settings** ‚Üí **Variables** –∏ –¥–æ–±–∞–≤—å—Ç–µ:

- **SUPABASE_URL**: `https://ugezbyszafkijwqifqlg.supabase.co` (–≤–∞—à Supabase URL)
- **SITE_URL**: `https://ccplearn.pages.dev` (–≤–∞—à —Å–∞–π—Ç)

### –®–∞–≥ 3: –ù–∞—Å—Ç—Ä–æ–π—Ç–µ Custom Domain –¥–ª—è Worker

**–í–∞—Ä–∏–∞–Ω—Ç A: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–æ–¥–¥–æ–º–µ–Ω–∞ (–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)**

1. –í Worker, –ø–µ—Ä–µ–π–¥–∏—Ç–µ –≤ **Triggers** ‚Üí **Add Custom Domain**
2. –í–≤–µ–¥–∏—Ç–µ: `auth.ccplearn.pages.dev` (–∏–ª–∏ –≤–∞—à –∫–∞—Å—Ç–æ–º–Ω—ã–π –¥–æ–º–µ–Ω)
3. Cloudflare –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞—Å—Ç—Ä–æ–∏—Ç DNS

**–í–∞—Ä–∏–∞–Ω—Ç B: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –¥–æ–º–µ–Ω–∞ —á–µ—Ä–µ–∑ Routes**

–ï—Å–ª–∏ —É –≤–∞—Å –µ—Å—Ç—å –∫–∞—Å—Ç–æ–º–Ω—ã–π –¥–æ–º–µ–Ω (–Ω–∞–ø—Ä–∏–º–µ—Ä, `yourdomain.com`):
1. –í Cloudflare Dashboard, –ø–µ—Ä–µ–π–¥–∏—Ç–µ –≤ –≤–∞—à –¥–æ–º–µ–Ω
2. **Workers Routes** ‚Üí **Add route**
3. –ú–∞—Ä—à—Ä—É—Ç: `auth.yourdomain.com/*` ‚Üí –≤—ã–±–µ—Ä–∏—Ç–µ –≤–∞—à Worker

### –®–∞–≥ 4: –ù–∞—Å—Ç—Ä–æ–π—Ç–µ Google OAuth

1. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ [Google Cloud Console](https://console.cloud.google.com/)
2. **APIs & Services** ‚Üí **Credentials** ‚Üí –≤–∞—à OAuth 2.0 Client ID
3. –í **Authorized redirect URIs** –¥–æ–±–∞–≤—å—Ç–µ:
   ```
   https://auth.ccplearn.pages.dev/auth/v1/callback
   ```
   (–∏–ª–∏ –≤–∞—à –ø–æ–¥–¥–æ–º–µ–Ω, –µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ –∫–∞—Å—Ç–æ–º–Ω—ã–π –¥–æ–º–µ–Ω)

4. **–í–ê–ñ–ù–û**: –£–¥–∞–ª–∏—Ç–µ –∏–ª–∏ –æ—Å—Ç–∞–≤—å—Ç–µ —Å—Ç–∞—Ä—ã–π URI —Å `supabase.co` (–¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –º–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å –æ–±–∞)

### –®–∞–≥ 5: –ù–∞—Å—Ç—Ä–æ–π—Ç–µ Supabase

1. –í Supabase Dashboard ‚Üí **Authentication** ‚Üí **URL Configuration**
2. **Site URL**: `https://ccplearn.pages.dev` (–≤–∞—à –æ—Å–Ω–æ–≤–Ω–æ–π —Å–∞–π—Ç)
3. **Redirect URLs**, –¥–æ–±–∞–≤—å—Ç–µ:
   ```
   https://auth.ccplearn.pages.dev/**
   https://ccplearn.pages.dev/**
   http://localhost:5173/**
   ```

### –®–∞–≥ 6: –û–±–Ω–æ–≤–∏—Ç–µ –∫–æ–¥ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

–ï—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ, —á—Ç–æ–±—ã OAuth –∑–∞–ø—Ä–æ—Å—ã —à–ª–∏ —á–µ—Ä–µ–∑ Worker, –º–æ–∂–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å `services/db.ts`:

```typescript
// –î–æ–±–∞–≤—å—Ç–µ –≤ –Ω–∞—á–∞–ª–æ —Ñ–∞–π–ª–∞, –ø–æ—Å–ª–µ –∏–º–ø–æ—Ä—Ç–æ–≤:
const SUPABASE_AUTH_PROXY = import.meta.env.VITE_SUPABASE_AUTH_PROXY || null;

// –û–±–Ω–æ–≤–∏—Ç–µ —Å–æ–∑–¥–∞–Ω–∏–µ Supabase –∫–ª–∏–µ–Ω—Ç–∞:
export const supabase = (SUPABASE_URL && SUPABASE_KEY) 
  ? createClient(SUPABASE_URL, SUPABASE_KEY, {
      auth: {
        persistSession: true,
        autoRefreshToken: true,
        detectSessionInUrl: true,
        // –ï—Å–ª–∏ —É–∫–∞–∑–∞–Ω auth proxy, –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ –¥–ª—è OAuth
        ...(SUPABASE_AUTH_PROXY && {
          // –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º fetch –¥–ª—è –ø—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏—è auth –∑–∞–ø—Ä–æ—Å–æ–≤
        })
      },
      global: {
        // –ü—Ä–æ–∫—Å–∏—Ä—É–µ–º auth –∑–∞–ø—Ä–æ—Å—ã —á–µ—Ä–µ–∑ Worker
        fetch: SUPABASE_AUTH_PROXY ? async (url, options) => {
          const urlObj = new URL(url);
          // –ï—Å–ª–∏ —ç—Ç–æ auth –∑–∞–ø—Ä–æ—Å, –ø—Ä–æ–∫—Å–∏—Ä—É–µ–º —á–µ—Ä–µ–∑ Worker
          if (urlObj.pathname.startsWith('/auth/v1/')) {
            const proxyUrl = url.replace(SUPABASE_URL, SUPABASE_AUTH_PROXY);
            return fetch(proxyUrl, options);
          }
          return fetch(url, options);
        } : undefined
      }
    })
  : null;
```

**–ò –¥–æ–±–∞–≤—å—Ç–µ –≤ `.env.local` –∏–ª–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è Cloudflare Pages:**
```
VITE_SUPABASE_AUTH_PROXY=https://auth.ccplearn.pages.dev
```

**–û–¥–Ω–∞–∫–æ**, —ç—Ç–æ –Ω–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ! Worker –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –∏ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ –∫–æ–¥–µ, –µ—Å–ª–∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å Google OAuth callback.

## –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

1. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∏–º–∞–µ—Ç "Sign in with Google"
2. Supabase –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç OAuth URL (—Å –¥–æ–º–µ–Ω–æ–º Supabase)
3. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –Ω–∞ Google
4. Google –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –¥–æ–º–µ–Ω –∏–∑ **Authorized redirect URI** (–≤–∞—à –¥–æ–º–µ–Ω —á–µ—Ä–µ–∑ Worker!)
5. –ü–æ—Å–ª–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ Google —Ä–µ–¥–∏—Ä–µ–∫—Ç–∏—Ç –Ω–∞ `https://auth.ccplearn.pages.dev/auth/v1/callback`
6. Worker –ø—Ä–æ–∫—Å–∏—Ä—É–µ—Ç –∑–∞–ø—Ä–æ—Å –Ω–∞ Supabase
7. Supabase –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç callback –∏ —Ä–µ–¥–∏—Ä–µ–∫—Ç–∏—Ç –Ω–∞ –≤–∞—à —Å–∞–π—Ç
8. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ø–∞–¥–∞–µ—Ç –Ω–∞ –≤–∞—à —Å–∞–π—Ç –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–º

## –ü—Ä–æ–≤–µ—Ä–∫–∞

1. –û—Ç–∫—Ä–æ–π—Ç–µ –≤–∞—à —Å–∞–π—Ç
2. –ù–∞–∂–º–∏—Ç–µ "Sign in with Google"
3. **–ü—Ä–æ–≤–µ—Ä—å—Ç–µ**: –í –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ Google –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å "to continue to **ccplearn.pages.dev**" (–∏–ª–∏ –≤–∞—à –¥–æ–º–µ–Ω)
4. –ü–æ—Å–ª–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –≤—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –Ω–∞ –≤–∞—à–µ–º —Å–∞–π—Ç–µ

## Troubleshooting

### Google –≤—Å–µ –µ—â–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç Supabase
- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤ Google Cloud Console –¥–æ–±–∞–≤–ª–µ–Ω –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π redirect URI —Å –≤–∞—à–∏–º –¥–æ–º–µ–Ω–æ–º
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ Worker —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç –∏ –∞–∫—Ç–∏–≤–µ–Ω
- –û—á–∏—Å—Ç–∏—Ç–µ –∫–µ—à –±—Ä–∞—É–∑–µ—Ä–∞

### OAuth –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ Worker –≤ Cloudflare Dashboard
- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –ø—Ä–∞–≤–∏–ª—å–Ω–æ
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –º–∞—Ä—à—Ä—É—Ç –Ω–∞—Å—Ç—Ä–æ–µ–Ω –ø—Ä–∞–≤–∏–ª—å–Ω–æ

### –†–µ–¥–∏—Ä–µ–∫—Ç –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Redirect URLs –≤ Supabase
- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ Site URL —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ø—Ä–∞–≤–∏–ª—å–Ω–æ
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ Worker –ø—Ä–∞–≤–∏–ª—å–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Ä–µ–¥–∏—Ä–µ–∫—Ç—ã

## –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π –∫–æ–¥–∞

–ï—Å–ª–∏ –Ω–µ —Ö–æ—Ç–∏—Ç–µ –º–µ–Ω—è—Ç—å –∫–æ–¥, –º–æ–∂–Ω–æ –ø—Ä–æ—Å—Ç–æ:
1. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å Worker (—à–∞–≥–∏ 1-3)
2. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å Google OAuth callback –Ω–∞ –≤–∞—à –¥–æ–º–µ–Ω (—à–∞–≥ 4)
3. –ù–∞—Å—Ç—Ä–æ–∏—Ç—å Supabase (—à–∞–≥ 5)

Worker –±—É–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ–∫—Å–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ –∑–∞–ø—Ä–æ—Å—ã –∫ `/auth/v1/callback` –Ω–∞ Supabase, –∏ Google –±—É–¥–µ—Ç –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –≤–∞—à –¥–æ–º–µ–Ω!

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–≠—Ç–æ —Ä–µ—à–µ–Ω–∏–µ –ø–æ–∑–≤–æ–ª—è–µ—Ç **–±–µ—Å–ø–ª–∞—Ç–Ω–æ** –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –≤–∞—à –¥–æ–º–µ–Ω –≤ Google OAuth –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ. –•–æ—Ç—è —Ç—Ä–µ–±—É–µ—Ç—Å—è –Ω–µ–∫–æ—Ç–æ—Ä–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞, —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Ç–æ–≥–æ —Å—Ç–æ–∏—Ç - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –±—É–¥—É—Ç –≤–∏–¥–µ—Ç—å –≤–∞—à –±—Ä–µ–Ω–¥ –≤–º–µ—Å—Ç–æ Supabase! üéâ
